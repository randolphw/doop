<html>
<head>
<title>D.O.O.P. v2.0</title>
<style type="text/css">
td {width: 100px; font-family: Arial; font-size: small; vertical-align: top;}
.heading {font-weight: bold;}
.center {text-align: center;}
.field {border: gray solid 1px; text-align: right;}
.input {border: gray solid 1px;}
.total {border: gray dotted 1px; background-color: #EFEFEF;}
.actual {border: #FFAA00 solid 1px;}
.output {border: #BB0000 solid 1px;}
.button {border: black solid 1px;}
.statbutton {width: 115px; outline: black solid 1px;}
.legname {width: 190px;}
.medname {width: 190px;}
.relname {width: 210px;}
.blename {width: 150px;}
.synname {width: 150px;}
.omename {width: 290px;}
.omedivision {width: 160px;}
.cosname {width: 200px;}
.cybname {width: 400px;}
.attname {width: 100px;}
.optiondelta {outline: #BB0000 solid 1px; text-align: right;}
.optionefficiency {outline: #FFAA00 solid 1px; text-align: right;}
.optioncost {outline: gray solid 1px; text-align: right;}
.optionstats {width: 115px; outline: gray solid 1px;}
</style>
<script src="options.js"></script> 
<script type="text/javascript">
<!--
function initialize () {
	base64 = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
	tagThing = {physical: 0, energy: 0, mental: 0, melee: 0, ranged: 0, area: 0, dot: 0, movement: 0, boss: 0, unaware: 0, HP: 0, SP: 0, DF: 0, TN: 0};
	stats = {AS: {display: "Attack Speed", percent: true	},
		CR: {display: "Critical Rating",
			subtype: {physical: {display: "physical",
						damagetype: true,
						linked: true},
				energy: {display: "energy",
						damagetype: true,
						linked: true	},
				mental: {display: "mental",
						damagetype: true,
						linked: true	},
				melee: {display: "melee",
						linked: true	},
				ranged: {display: "ranged",
						linked: true	},
				area: {display: "area",
						linked: true	},
				movement: {display: "movement",
						linked: true,
						nosheet: true	}
			}
		},
		CD: {display: "Critical Damage"	},
		BR: {display: "Brutal Rating"	},
		BD: {display: "Brutal Damage"	},
		DR: {display: "Damage Rating",
			subtype: {physical: {display: "Physical DR",
						damagetype: true,
						linked: true	},
				energy: {display: "Energy DR",
						damagetype: true,
						linked: true	},
				mental: {display: "Mental DR",
						damagetype: true,
						linked: true	},
				melee: {display: "Melee DR"	},
				ranged: {display: "Ranged DR"	},
				area: {display: "Area DR",
					nosheet: true		},
				dot: {display: "DOT DR",
					nosheet: true		},
				movement: {display: "Movement DR",
					nosheet: true		},
				boss: {display: "Boss DR",
					nosheet: true		},
				unaware: {display: "Unaware DR",
					nosheet: true		}
			}
		},
		DB: {display: "Base Damage",
			percent: true,
			subtype: {physical: {display: "Base Damage",
						percent: true	},
				energy: {display: "Base Damage",
						percent: true	},
				mental: {display: "Base Damage",
						percent: true	},
				melee: {display: "Base Damage",
						percent: true	},
				ranged: {display: "Base Damage",
						percent: true	},
				area: {display: "Extra Damage",
						percent: true,
						nosheet: true	},
				dot: {display: "Extra Damage",
						percent: true,
						nosheet: true	},
				movement: {display: "Extra Damage",
						percent: true,
						nosheet: true	},
				boss: {display: "Extra Damage",
						percent: true,
						nosheet: true	},
				unaware: {display: "Extra Damage",
						percent: true,
						nosheet: true	}
			}
		},
		HP: {display: "Health",
			integertotal: true	},
		SP: {display: "Spirit",
			integertotal: true	},
		DF: {display: "Defense",
			integertotal: true	},
		TN: {display: "Tenacity",
			integertotal: true	},
		SK: {display: "All Skills",
			integertotal: true	}
	};
	equipped = {};
	var buildStatTable = function (prefix, subtype) {
				var currentStat = (subtype) ? stats[prefix].subtype[subtype] : stats[prefix];
				var fieldName = prefix + ((subtype) ? subtype : "");

var targetRow = (prefix == "DB") ? 13 + (rowcount - 23) * 2 : rowcount;

				var newRow = statsTable.insertRow(targetRow);
				newRow.className = prefix + " " + ((subtype) ? subtype : "");
				var newCell = newRow.insertCell(0);
				newCell.innerHTML = ((prefix == "CR" && subtype) ? "&rarr;" : "") + ((prefix == "DB") ? "&rarr;" : "") + currentStat.display;
				newCell = newRow.insertCell(1);
				if (!(currentStat.nosheet)) {
					newCell.id = "sheet_" + fieldName;
					newCell.className = "field input";
					newCell.onclick = function() {selectField(this.id)};
				};
				newCell = newRow.insertCell(2);
				newCell.id = "total_" + fieldName;
				newCell.className = "field total";
				newCell.innerHTML = "0";
				newCell = newRow.insertCell(3);
				newCell.id = "actual_" + fieldName;
				newCell.className = "field actual";
				newCell.innerHTML = "0";
				newCell = newRow.insertCell(4);
				newCell.id = "value_" + fieldName;
				newCell.className = "field";
				newCell = newRow.insertCell(5);
				newCell.id = "weight_" + fieldName;
				newCell.className = "field";
				rowcount++;
			};
	var rowcount = 0;
	for (x in stats) {
		buildStatTable(x);
		stats[x].value = 0;
		if (stats[x].subtype) {
			for (y in stats[x].subtype) {
				buildStatTable(x, y);
				stats[x].subtype[y].value = 0;
			};
		};
	};

// reordering

//

	var newRow = statsTable.insertRow(0);
	var newCell = newRow.insertCell(0);
	newCell.className = "heading center";
	newCell.innerHTML = "Statistics";
	newCell = newRow.insertCell(1);
	newCell.className = "heading center";
	newCell.innerHTML = "Sheet";
	newCell = newRow.insertCell(2);
	newCell.className = "heading center";
	newCell.innerHTML = "Subtotal";
	newCell = newRow.insertCell(3);
	newCell.className = "heading center";
	newCell.innerHTML = "Actual";
	newCell = newRow.insertCell(4);
	newCell.className = "heading center";
	newCell.innerHTML = "+1% Damage";
	newCell = newRow.insertCell(5);
	newCell.className = "heading center";
	newCell.innerHTML = "Weight in DR";
	var buildOptionTable = function (system) {
		var systemObject = masterOptions[system];
		var stem = system.substr(0, 3).toLowerCase();
		var optionTable = document.createElement("TABLE");
		optionTable.id = stem + "Table";
		if (stem != "leg") {
			optionTable.hidden = true;
		};
		document.getElementById("comparisons").appendChild(optionTable);
		var optionIndex = 0;
		for (option in systemObject) {
			var thisOption = systemObject[option];
			var ranks = (thisOption.ranks) ? thisOption.ranks : 1;
			for (var i = 0; i < ranks; i++) {
				var newRow = optionTable.insertRow(optionIndex);
				var newCell = newRow.insertCell(0);
				newCell.className = stem + "name";
				var innerTable = document.createElement("TABLE");
				innerTable.cellSpacing = 0;
				innerTable.cellPadding = 0;
				var innerRow = innerTable.insertRow(0);
				var innerCell = innerRow.insertCell(0);
				innerCell.id = stem + "Name" + optionIndex;
				innerCell.className = stem + "name";
				newCell.appendChild(innerTable);
				newCell = newRow.insertCell(1);
				var innerTable = document.createElement("TABLE");
				innerTable.cellSpacing = 0;
				innerTable.cellPadding = 0;
				var innerRow = innerTable.insertRow(0);
				var innerCell = innerRow.insertCell(0);
				innerCell.id = stem + "DPS" + optionIndex;
				innerCell.className = "optiondelta";
				newCell.appendChild(innerTable);
				newCell = newRow.insertCell(2);
				var innerTable = document.createElement("TABLE");
				innerTable.cellSpacing = 0;
				innerTable.cellPadding = 0;
				var innerRow = innerTable.insertRow(0);
				var innerCell = innerRow.insertCell(0);
				innerCell.id = stem + "Stats" + optionIndex;
				innerCell.className = "optionstats " + stem + "stats";
				innerCell.hidden = true;
				newCell.appendChild(innerTable);
				if (system == "Omega_Points") {
					newCell = newRow.insertCell(2);
					var innerTable = document.createElement("TABLE");
					innerTable.cellSpacing = 0;
					innerTable.cellPadding = 0;
					var innerRow = innerTable.insertRow(0);
					var innerCell = innerRow.insertCell(0);
					innerCell.id = stem + "Efficiency" + optionIndex;
					innerCell.className = "optionefficiency";
					newCell.appendChild(innerTable);
					newCell = newRow.insertCell(3);
					var innerTable = document.createElement("TABLE");
					innerTable.cellSpacing = 0;
					innerTable.cellPadding = 0;
					var innerRow = innerTable.insertRow(0);
					var innerCell = innerRow.insertCell(0);
					innerCell.id = stem + "Cost" + optionIndex;
					innerCell.className = "optioncost";
					newCell.appendChild(innerTable);
					newCell = newRow.insertCell(0);
					newCell.className = "omedivision";
					var innerTable = document.createElement("TABLE");
					innerTable.cellSpacing = 0;
					innerTable.cellPadding = 0;
					var innerRow = innerTable.insertRow(0);
					var innerCell = innerRow.insertCell(0);
					innerCell.id = stem + "Division" + optionIndex;
					innerCell.className = "omedivision";
					newCell.appendChild(innerTable);
				};
				optionIndex++;
			};
		};
		var newRow = optionTable.insertRow(0);
		var newCell = newRow.insertCell(0);
		newCell.className = "heading";
		newCell.innerHTML = "Name";
		newCell = newRow.insertCell(1);
		newCell.className = "heading center";
		newCell.innerHTML = "Damage";
		if (system != "Attributes") {
			newCell = newRow.insertCell(2);
			newCell.className = "statbutton center";
			newCell.innerHTML = "show details";
			newCell.onclick = function () {
				var optionStats = document.getElementsByClassName(stem + "stats");
				if (this.innerHTML == "show details") {
					this.innerHTML = "hide details";
					for (var i = 0; i < optionStats.length; i++) {
						optionStats[i].hidden = false;
					};
				} else {
					this.innerHTML = "show details";
					for (var i = 0; i < optionStats.length; i++) {
						optionStats[i].hidden = true;
					};
				};
			};
		};
		if (system == "Omega_Points") {
			newCell = newRow.insertCell(2);
			newCell.className = "heading center";
			newCell.innerHTML = "Efficiency";
			newCell = newRow.insertCell(3);
			newCell.className = "heading center";
			newCell.id = "omegaTotal";
			newCell.innerHTML = "0/7500 &Omega;";
			newCell = newRow.insertCell(0);
			newCell.className = "heading";
			newCell.innerHTML = "Division";
		};
	};
	var systemIndex = 0;
	for (system in masterOptions) {
		var headingRow = document.getElementById("optionHeadings").rows[0];
		var newCell = headingRow.insertCell(systemIndex);
		newCell.className = "button center";
		newCell.innerHTML = system.replace("_", " ");
		switch (system) {
			case "Relics":
				newCell.innerHTML += " (1000)";
				break;
			case "Blessings":
				newCell.innerHTML += " (4)";
				break;
		};
		if (systemIndex == 0) {
			newCell.style.backgroundColor = "666666";
			newCell.style.color = "FFFFFF";
		};
		buildOptionTable(system);
		newCell.onclick = function () {
			var systemIndex = 0;
			for (system in masterOptions) {
				var stem = system.substr(0, 3).toLowerCase();
				var optionTable = document.getElementById(stem + "Table");
				optionTable.hidden = true;
				this.parentNode.cells[systemIndex].style.backgroundColor = "initial";
				this.parentNode.cells[systemIndex].style.color = "initial";
				systemIndex++;
			};
			this.style.backgroundColor = "666666";
			this.style.color = "FFFFFF";
			var stem = this.innerHTML.substr(0, 3).toLowerCase();
			var optionTable = document.getElementById(stem + "Table");
			optionTable.hidden = false;
		};
		systemIndex++;
	};
	resetChecks();
	selectedField = "sheet_AS";
	textbuffer = "0";
	textsuffix = "";
	textdigits = 0;
	var importArray = (location.search.length > 0) ? location.search.substr(1).split(":") : ["phyGS2,0,0,0", "melGS2,0,0,0", "bosGS2,0,0,0"];
	for (var i = 0; i < importArray.length; i++) {
		var prefix = importArray[i].substr(0, 3);
		switch (prefix) {
			case "phy":
				prefix = "physical";
				break;
			case "ene":
				prefix = "energy";
				break;
			case "men":
				prefix = "mental";
				break;
			case "mel":
				prefix = "melee";
				break;
			case "ran":
				prefix = "ranged";
				break;
			case "are":
				prefix = "area";
				break;
			case "dot":
				prefix = "dot";
				break;
			case "mov":
				prefix = "movement";
				break;
			case "bos":
				prefix = "boss";
				break;
			case "una":
				prefix = "unaware";
				break;
			case "HP_":
				prefix = "HP";
				break;
			case "SP_":
				prefix = "SP";
				break;
			case "DF_":
				prefix = "DF";
				break;
			case "TN_":
				prefix = "TN";
				break;
		};
		switch (prefix) {
			case "bas":
			case "equ":
			case "syn":
			case "cos":
				break;
			default:
				document.getElementById("check" + prefix.substr(0,1).toUpperCase() + prefix.substr(1)).checked = true;
				toggleBlock(prefix, true);
				break;
		};
		var ratings = importArray[i].substr(3).split(",");
		for (var j = 0; j < ratings.length; j++) {
			ratings[j] = integerFrom64(ratings[j]);
		};
		switch (prefix) {
			case "bas":
				stats.AS.value = ratings[0] / 10000;
				stats.CR.value = ratings[1];
				stats.CD.value = ratings[2];
				stats.BR.value = ratings[3];
				stats.BD.value = ratings[4];
				stats.DR.value = ratings[5];
				stats.DB.value = ratings[6] / 10000;
				break;
			case "equ":
				if (ratings[0] > 0) {
					selectOption("Legendary", Object.keys(masterOptions["Legendary"])[ratings[0] - 1]);
				};
				if (ratings[1] > 0) {
					selectOption("Medallion", Object.keys(masterOptions["Medallion"])[ratings[1] - 1]);
				};
				if (ratings[2] > 0) {
					selectOption("Relics", Object.keys(masterOptions["Relics"])[ratings[2] - 1]);
				};
				if (ratings[3] > 0) {
					selectOption("Blessings", Object.keys(masterOptions["Blessings"])[ratings[3] - 1]);
				};
				break;
			case "cos":
				for (var j = 0; j < ratings.length; j++) {
					selectOption("Costume_Affixes", Object.keys(masterOptions["Costume_Affixes"])[ratings[j] - 1]);
				};
				break;
			case "syn":
				for (var j = 0; j < ratings.length; j++) {
					selectOption("Synergies", Object.keys(masterOptions["Synergies"])[ratings[j] - 1]);
				};
				break;
			default:
				tagThing[prefix] = ratings[0] / 10000;
				document.getElementById("tag_EZ" + prefix).innerHTML = fixedToPercent(tagThing[prefix]);
				if (prefix == "HP" || prefix == "SP" || prefix == "DF" || prefix == "TN") {
					stats[prefix].value = ratings[1];
				} else {
					if (stats.CR.subtype[prefix] && !stats.CR.subtype[prefix].nosheet) {
						stats.CR.subtype[prefix].value = ratings[1];
					};
					if (stats.DR.subtype[prefix] && !stats.DR.subtype[prefix].nosheet) {
						stats.DR.subtype[prefix].value = ratings[2];
						stats.DB.subtype[prefix].value = ratings[3] / 10000;
					};
				};
				break;
		};
	};
	update();
	selectField("sheet_AS");
};

function selectOption (system, selection) {
	var systemObject = masterOptions[system];
	var selectedOption = systemObject[selection];
	var equip = function (option) {
		option.equipped = true;
		for (stat in option.stats) {
			if (equipped[stat]) {
				equipped[stat] += option.stats[stat];
				if (equipped[stat] == 0) {
					delete equipped[stat];
				};
			} else {
				equipped[stat] = option.stats[stat];
			};
		};
// SLOW: Auto-equip single-path prereqs
//		if (option.rank) {
//			var urOption = omegaSeeds[option.key.slice(0, option.key.indexOf("_"))];
//			if (urOption.prereq && urOption.prereq.length == 1 && ! (omegaSeeds[urOption.prereq[0]].equipped)) {
//				var prereq = urOption.prereq[0] + "_1";
//				selectOption("Omega_Points", prereq);
//			};
//		};
	};
	var unequip = function (option) {
		delete option.equipped;
		for (stat in option.stats) {
			if (equipped[stat]) {
				equipped[stat] -= option.stats[stat];
				if (equipped[stat] == 0) {
					delete equipped[stat];
				};
			} else {
				equipped[stat] = option.stats[stat];
			};
		};
	};
	if (system != "Synergies") {
		for (option in systemObject) {
			var checkOption = systemObject[option];
			if (option != selection && checkOption.equipped && (!(checkOption.grade) || checkOption.grade == selectedOption.grade) && (!(checkOption.rank) || checkOption.name == selectedOption.name)) {
				unequip(checkOption);
			};
		};
	};
	if (selectedOption.equipped) {
		unequip(selectedOption);
		if (system == "Omega_Points") {
			var urOption = selection.slice(0, selection.indexOf("_"));
			omegaSeeds[urOption].equipped = false;
		};
	} else {
		if (system == "Synergies") {
			var synergies = 0;
			for (option in systemObject) {
				if (systemObject[option].equipped) {
					synergies++;
				};
			};
		};
		if (system != "Synergies" || synergies < 10) {
			equip(selectedOption);
			if (system == "Omega_Points") {
				var urOption = selection.slice(0, selection.indexOf("_"));
				omegaSeeds[urOption].equipped = true;
			};
		};
	};
	update();
};

function selectField (field) {
	readText (selectedField);
	validateText ();
	editing = 0;
	document.getElementById(selectedField).style.border = "gray solid 1px";
	document.getElementById(selectedField).style.outline = "initial";
	selectedField = field;
	document.getElementById(selectedField).style.border = "#2F8FFF solid 1px";
	document.getElementById(selectedField).style.outline = "#2F8FFF solid 1px";
	readText (selectedField);
};

function readText (field) {
	textbuffer = document.getElementById(field).innerHTML
	if (textbuffer.substr(-1) == "%") {
		textbuffer = textbuffer.slice(0, textbuffer.length - 1);
		textsuffix = "%";
		textdigits = 2;
	} else {
		textsuffix = "";
		textdigits = 0;
	};
};

function attTotal (item) {
	var total = {DUR: (item.ATdurability) ? item.ATdurability : 0,
		STR: (item.ATstrength) ? item.ATstrength : 0,
		FIG: (item.ATfighting) ? item.ATfighting : 0,
		SPE: (item.ATspeed) ? item.ATspeed : 0,
		ENE: (item.ATenergy) ? item.ATenergy : 0,
		INT: (item.ATintelligence) ? item.ATintelligence : 0
	};
	if (item.ATcosmic) {
		var damagetypes = ((tagThing.physical > 0) ? 1 : 0) + ((tagThing.energy > 0) ? 1 : 0) + ((tagThing.mental > 0) ? 1 : 0);
		total.DUR += damagetypes * item.ATcosmic;
		total.STR += damagetypes * item.ATcosmic;
		total.FIG += damagetypes * item.ATcosmic;
		total.SPE += damagetypes * item.ATcosmic;
		total.ENE += damagetypes * item.ATcosmic;
		total.INT += damagetypes * item.ATcosmic;
	};
	return total;
};

function calcLinks (prefix, subtype) {
	var total = attTotal(equipped);
	var currentStat = (subtype) ? stats[prefix].subtype[subtype] : stats[prefix];
	var equipStat = (subtype) ? equipped[prefix + subtype] : equipped[prefix];
	var linkedValue = (prefix != "AS") ? ((equipStat) ? equipStat : 0) : 0;
	switch (prefix) {
		case "CR":
			linkedValue += tagThing.TN * stats.TN.actual + total.INT * 30;
			linkedValue += (subtype && equipped.CR) ? equipped.CR : 0;
			break;
		case "CD":
			linkedValue += total.INT * 90;
			break;
		case "BR":
			linkedValue += total.FIG * 60;
			break;
		case "BD":
			linkedValue += total.FIG * 180;
			break;
		case "DR":
			linkedValue += (currentStat.linked && equipped.DR) ? equipped.DR : 0;
			break;
		case "DB":
			if (subtype) {
				switch (subtype) {
					case "physical":
						linkedValue += total.STR * 0.04;
						break;
					case "energy":
					case "mental":
						linkedValue += total.ENE * 0.04;
						break;
				};
			} else {
				linkedValue += total.FIG * 0.03
			};
			break;
		case "HP":
			linkedValue += total.DUR * 180;
			break;
		case "SP":
			linkedValue += total.INT * 2;
			break;
		case "TN":
			linkedValue += total.SPE * 15;
			break;
	};
	return linkedValue;
};

function validateText () {
	if (isNaN(textbuffer)) {
		textbuffer = 0;
	};
	var newNumber = Number(textbuffer);
	if (selectedField.substr(0, 6) == "tag_EZ") {
		newNumber = Math.max(0, newNumber);
		if (selectedField.substr(6, 2) != "SP") {
			newNumber = Math.min(100, newNumber);
		};
	};
	if (selectedField == "sheet_AS") {
		newNumber = Math.min(40, newNumber);
	};
	if (textdigits == 2) {
		newNumber = Math.min(99999999, newNumber);
	};
	if (Number(newNumber.toFixed(textdigits)) == 0 && newNumber.toFixed(textdigits).substr(0, 1) == "-") {
		newNumber = 0;
	};
	textbuffer = newNumber.toFixed(textdigits);
	if (selectedField.substr(0, 6) == "tag_EZ") {
		var subtype = selectedField.slice(6);
		tagThing[subtype] = textbuffer / 100;
	} else {
		var prefix = selectedField.substr(6, 2);
		var subtype = selectedField.substr(8);
		var currentStat = (subtype) ? stats[prefix].subtype[subtype] : stats[prefix];
		var linkedValue = ((currentStat.linked) ? stats[prefix].value : 0) + calcLinks(prefix, subtype);
		currentStat.value = (textsuffix == "%") ? (textbuffer) / 100 - linkedValue : textbuffer - linkedValue;
	};
	update();
};

function update () {
// Conversion calculations
	var total = attTotal(equipped);
	stats.HP.total = stats.HP.value + ((equipped.HP) ? equipped.HP : 0) + total.DUR * 180;
	stats.HP.actual = stats.HP.total;
	stats.SP.total = stats.SP.value + ((equipped.SP) ? equipped.SP : 0) + total.INT * 2;
	stats.SP.actual = stats.SP.total;
	stats.DF.total = stats.DF.value + ((equipped.DF) ? equipped.DF : 0);
	stats.DF.actual = stats.DF.total;
	stats.TN.total = stats.TN.value + ((equipped.TN) ? equipped.TN : 0) + total.SPE * 15;
	stats.TN.actual = stats.TN.total;
	var cnvCR = tagThing.TN * stats.TN.actual;
	var cnvDR = tagThing.HP * stats.HP.actual + tagThing.SP * stats.SP.actual + tagThing.DF * stats.DF.actual;
// Update stats
	var totalStats = function (prefix, subtype) {
		var currentStat = (subtype) ? stats[prefix].subtype[subtype] : stats[prefix];
		var equipStat = (subtype) ? equipped[prefix + subtype] : equipped[prefix];
		switch (prefix) {
			case "AS":
				currentStat.total = ((currentStat.value > 0.125) ? (Math.log(1 - (currentStat.value * 2.5)) / -3) : currentStat.value) + ((equipStat) ? equipStat : 0) + total.SPE * 0.01;
				currentStat.actual = Math.min(currentStat.total, 0.4 * (1 - Math.exp(-3 * currentStat.total)));
				break;
			case "CR":
				currentStat.total = ((currentStat.linked) ? stats[prefix].total : total.INT * 30 + cnvCR) + currentStat.value + ((equipStat) ? equipStat : 0);
				if (!(currentStat.linked)) {
					if (tagThing.melee > 0 && equipped.CR_if_melee) {
						currentStat.total += equipped.CR_if_melee;
					};
					if (tagThing.ranged > 0 && equipped.CR_if_ranged) {
						currentStat.total += equipped.CR_if_ranged;
					};
				};
				currentStat.actual = currentStat.total * 0.99 / (currentStat.total + 3601) + ((equipped.CC) ? equipped.CC : 0);
				currentStat.actual += ((subtype && equipped["CC" + subtype]) ? equipped["CC" + subtype] : 0);
				if (subtype && tagThing.movement > 0 && equipped["CC" + subtype + "_if_movement"]) {
					currentStat.actual += equipped["CC" + subtype + "_if_movement"];
				};
				break;
			case "BR":
				currentStat.total = ((currentStat.linked) ? stats[prefix].total : total.FIG * 60) + currentStat.value + ((equipStat) ? equipStat : 0);
				if (!(currentStat.linked) && tagThing.melee > 0 && equipped.BR_if_melee) {
					currentStat.total += equipped.BR_if_melee;
				};
				currentStat.actual = currentStat.total * 0.75 / (currentStat.total + 3601) + ((equipped.BC) ? equipped.BC : 0);
				break;
			case "CD":
				currentStat.total = currentStat.value + total.INT * 90 + ((equipStat) ? equipStat : 0);
				if (tagThing.melee > 0 && equipped.CD_if_melee) {
					currentStat.total += equipped.CD_if_melee;
				};
				if (tagThing.ranged > 0 && equipped.CD_if_ranged) {
					currentStat.total += equipped.CD_if_ranged;
				};
				currentStat.actual = currentStat.total / 8000 + 1.5 + ((equipped.CM) ? equipped.CM : 0);
				break;
			case "BD":
				currentStat.total = stats.CD.total + currentStat.value + total.FIG * 180 + ((equipStat) ? equipStat : 0);
				currentStat.actual = currentStat.total / 8000 + 3 + ((equipped.BM) ? equipped.BM : 0);
				break;
			case "DR":
				currentStat.total = ((currentStat.linked) ? stats[prefix].total : 0) + currentStat.value + ((subtype) ? 0 : cnvDR) + ((equipStat) ? equipStat : 0);
				if ((tagThing.physical * tagThing.energy > 0 || tagThing.physical * tagThing.mental > 0 || tagThing.energy * tagThing.mental > 0) && currentStat.linked && equipped.DRcosmic > 0) {
					currentStat.total += equipped.DRcosmic;
				};
				if (subtype && tagThing.ranged > 0 && equipped["DR" + subtype + "_if_ranged"]) {
					currentStat.total += equipped["DR" + subtype + "_if_ranged"];
				};
				currentStat.actual = currentStat.total / 4000;
				break;
			case "DB":
				currentStat.total = currentStat.value + ((equipStat) ? equipStat : 0);
				if (subtype) {
					switch (subtype) {
						case "physical":
							currentStat.total += total.STR * 0.04;
							if (tagThing.energy > 0 && equipped.DBphysical_if_energy) {
								currentStat.total += equipped.DBphysical_if_energy;
							};
							if (tagThing.mental > 0 && equipped.DBphysical_if_mental) {
								currentStat.total += equipped.DBphysical_if_mental;
							};
							if (tagThing.movement > 0 && equipped.DBphysical_if_movement) {
								currentStat.total += equipped.DBphysical_if_movement;
							};
							break;
						case "energy":
							currentStat.total += total.ENE * 0.04;
							if (tagThing.physical > 0 && equipped.DBenergy_if_physical) {
								currentStat.total += equipped.DBenergy_if_physical;
							};
							if (tagThing.mental > 0 && equipped.DBenergy_if_mental) {
								currentStat.total += equipped.DBenergy_if_mental;
							};
							if (tagThing.movement > 0 && equipped.DBenergy_if_movement) {
								currentStat.total += equipped.DBenergy_if_movement;
							};
							if (tagThing.area > 0 && equipped.DBenergy_if_area) {
								currentStat.total += equipped.DBenergy_if_area;
							};
							break;
						case "mental":
							currentStat.total += total.ENE * 0.04;
							if (tagThing.physical > 0 && equipped.DBmental_if_physical) {
								currentStat.total += equipped.DBmental_if_physical;
							};
							if (tagThing.movement > 0 && equipped.DBmental_if_movement) {
								currentStat.total += equipped.DBmental_if_movement;
							};
							if (equipped.SP_to_mental) {
								currentStat.total += equipped.SP_to_mental * stats.SP.total;
							};
							break;
						case "area":
							if (tagThing.energy > 0 && equipped.DBarea_if_energy) {
								currentStat.total += equipped.DBarea_if_energy;
							};
							break;
						case "movement":
							currentStat.total += total.SPE * 0.02;
							break;
					};
				} else {
					currentStat.total += total.FIG * 0.03;
				};
				currentStat.actual = currentStat.total;
				break;
			case "SK":
				currentStat.total = currentStat.value + ((equipStat) ? equipStat : 0);
				currentStat.actual = currentStat.total;
				break;
		};
	};
	for (x in stats) {
		totalStats(x);
		if (stats[x].subtype) {
			for (y in stats[x].subtype) {
			totalStats(x, y);
			};
		};
	};
// DPS calculation
	var ezCR = {base: 0};
	var ezDB = {base: 0};
	for (k in stats.DR.subtype) {
		if (stats.CR.subtype[k] && !(stats.CR.subtype[k].damagetype)) {
			ezCR.base += tagThing[k] * (stats.CR.subtype[k].total - stats.CR.total);
		};
		if (!(stats.DR.subtype[k].damagetype)) {
			ezDB.base += tagThing[k] * (stats.DR.subtype[k].actual + stats.DB.subtype[k].actual);
		};
	};
	ezCR.base = Math.max(0, ezCR.base);
	ezDB.base = 1 + stats.DB.actual + Math.max(0, ezDB.base);
	var newCR = {};
	var ezIndex = 0;
	for (k in stats.CR.subtype) {
		if (stats.CR.subtype[k].damagetype) {
			newCR[k] = ezCR.base + stats.CR.subtype[k].total;
			ezCR[k] = newCR[k] * 0.99 / (newCR[k] + 3601) + ((equipped.CC) ? equipped.CC : 0) + ((equipped["CC"+k]) ? equipped["CC"+k] : 0) + ((tagThing.movement > 0 && equipped["CC" + k + "_if_movement"]) ? equipped["CC" + k + "_if_movement"] : 0);
			ezDB[k] = ezDB.base + stats.DR.subtype[k].actual + stats.DB.subtype[k].actual;
			ezIndex += tagThing[k] * calcIndex(ezDB[k], ezCR[k], stats.CD.actual, stats.BR.actual, stats.BD.actual);
		};
	};
// DPS option comparisons
	var optionDPS = function (system) {
		var systemObject = masterOptions[system];
		var output = system.substr(0, 3).toLowerCase();
		switch (output) {
			case "cos":
			case "cyb":
			case "ome":
			case "syn":
				var currentArray = [];
				for (option in systemObject) {
					if (systemObject[option].equipped) {
						currentArray.push(systemObject[option]);
					};
				};
				break;
			default:
				for (option in systemObject) {
					if (systemObject[option].equipped) {
						var currentOption = systemObject[option];
					};
				};
				break;
		};
		for (option in systemObject) {
			var thisOption = systemObject[option];
			var compareItem = {stats: {}};
			for (stat in thisOption.stats) {
				compareItem.stats[stat] = thisOption.stats[stat];
			};
			if (thisOption.cost) {
				compareItem.cost = thisOption.cost();
			};
			var opportunityCost = function (item) {
				if (item.cost) {
					compareItem.cost -= item.cost();
if (compareItem.name == "Arcane Attunement") {
alert("yes");
};
				};
				for (stat in item.stats) {
					if (compareItem.stats[stat]) {
						compareItem.stats[stat] -= item.stats[stat];
					} else {
						compareItem.stats[stat] = -item.stats[stat];
					};
				};
			};
			if (currentArray || currentOption) {
				switch (output) {
					case "cos":
					case "cyb":
						for (var j = 0; j < currentArray.length; j++) {
							if (currentArray[j].grade == thisOption.grade) {
								opportunityCost(currentArray[j]);
							};
						};
						break;
					case "ome":
					case "syn":
						if (thisOption.equipped) {
							var compareItem = {stats: {}, cost: 0};
						};
						for (var j = 0; j < currentArray.length; j++) {
							if (currentArray[j].name == thisOption.name) {
								opportunityCost(currentArray[j]);
							};
						};
						break;
					default:
						opportunityCost(currentOption);
						break;
				};
			};
			var itemIndex = 0;
			var item = attTotal(compareItem.stats);
			var worn = attTotal(equipped);
			item.HP = ((compareItem.stats.HP) ? compareItem.stats.HP : 0) + item.DUR * 180;
			item.SP = ((compareItem.stats.SP) ? compareItem.stats.SP : 0) + item.INT * 2;
			item.DF = (compareItem.stats.DF) ? compareItem.stats.DF : 0;
			item.TN = ((compareItem.stats.TN) ? compareItem.stats.TN : 0) + item.SPE * 15;
			var itemcnvDR = tagThing.HP * item.HP + tagThing.SP * item.SP + tagThing.DF * item.DF;
			item.BR = stats.BR.total + ((compareItem.stats.BR) ? compareItem.stats.BR : 0) + item.FIG * 60;
			if (tagThing.melee > 0 && compareItem.stats.BR_if_melee) {
				item.BR += compareItem.stats.BR_if_melee;
			};
			item.BR = item.BR * 0.75 / (item.BR + 3601) + ((equipped.BC) ? equipped.BC : 0) + ((compareItem.stats.BC) ? compareItem.stats.BC : 0);
			item.CD = ((compareItem.stats.CD) ? compareItem.stats.CD : 0) + item.INT * 90;
			if (tagThing.melee > 0 && compareItem.stats.CD_if_melee) {
				item.CD += compareItem.stats.CD_if_melee;
			};
			if (tagThing.ranged > 0 && compareItem.stats.CD_if_ranged) {
				item.CD += compareItem.stats.CD_if_ranged;
			};
			item.BD = item.CD + ((compareItem.stats.BD) ? compareItem.stats.BD : 0) + item.FIG * 180;
			item.CD = stats.CD.actual + item.CD / 8000 + ((compareItem.stats.CM) ? compareItem.stats.CM : 0);
			item.BD = stats.BD.actual + item.BD / 8000 + ((compareItem.stats.BM) ? compareItem.stats.BM : 0);
			for (k in stats.CR.subtype) {
				if (stats.CR.subtype[k].damagetype) {
					item.CR = newCR[k] + ((compareItem.stats.CR) ? compareItem.stats.CR : 0) + item.INT * 30 + tagThing.TN * item.TN;
					item.CR += (compareItem.stats["CR" + k]) ? compareItem.stats["CR" + k] : 0;
					if (tagThing.melee > 0 && compareItem.stats.CR_if_melee) {
						item.CR += compareItem.stats.CR_if_melee;
					};
					if (tagThing.ranged > 0 && compareItem.stats.CR_if_ranged) {
						item.CR += compareItem.stats.CR_if_ranged;
					};
					for (tag in stats.CR.subtype) {
						if (!(stats.CR.subtype[tag].damagetype)) {
							item.CR += (compareItem.stats["CR" + tag]) ? tagThing[tag] * compareItem.stats["CR" + tag] : 0;
						};
					};
					item.CR = item.CR * 0.99 / (item.CR + 3601) + ((compareItem.stats.CC) ? compareItem.stats.CC : 0) + ((compareItem.stats["CC" + k]) ? compareItem.stats["CC" + k] : 0) + ((tagThing.movement > 0 && compareItem.stats["CC" + k + "_if_movement"]) ? compareItem.stats["CC" + k + "_if_movement"] : 0) + ((equipped.CC) ? equipped.CC : 0) + ((equipped["CC" + k]) ? equipped["CC" + k] : 0) + ((tagThing.movement > 0 && equipped["CC" + k + "_if_movement"]) ? equipped["CC" + k + "_if_movement"] : 0);
					item.DB = (((compareItem.stats.DR) ? compareItem.stats.DR : 0) + itemcnvDR) / 4000 + ((compareItem.stats.DB) ? compareItem.stats.DB : 0) + item.FIG * 0.03;
					item.DB += ((compareItem.stats["DR" + k]) ? compareItem.stats["DR" + k] / 4000 : 0) + ((compareItem.stats["DB" + k]) ? compareItem.stats["DB" + k] : 0);
					switch (k) {
						case "physical":
							item.DB += item.STR * 0.04;
							if (tagThing.energy > 0 && compareItem.stats.DBphysical_if_energy) {
								item.DB += compareItem.stats.DBphysical_if_energy;
							};
							if (tagThing.mental > 0 && compareItem.stats.DBphysical_if_mental) {
								item.DB += compareItem.stats.DBphysical_if_mental;
							};
							if (tagThing.movement > 0 && compareItem.stats.DBphysical_if_movement) {
								item.DB += compareItem.stats.DBphysical_if_movement;
							};
							break;
						case "energy":
							item.DB += item.ENE * 0.04;
							if (tagThing.physical > 0 && compareItem.stats.DBenergy_if_physical) {
								item.DB += compareItem.stats.DBenergy_if_physical;
							};
							if (tagThing.mental > 0 && compareItem.stats.DBenergy_if_mental) {
								item.DB += compareItem.stats.DBenergy_if_mental;
							};
							if (tagThing.movement > 0 && compareItem.stats.DBenergy_if_movement) {
								item.DB += compareItem.stats.DBenergy_if_movement;
							};
							if (tagThing.area > 0 && compareItem.stats.DBenergy_if_area) {
								item.DB += compareItem.stats.DBenergy_if_area;
							};
							break;
						case "mental":
							item.DB += item.ENE * 0.04;
							if (tagThing.physical > 0 && compareItem.stats.DBmental_if_physical) {
								item.DB += compareItem.stats.DBmental_if_physical;
							};
							if (tagThing.movement > 0 && compareItem.stats.DBmental_if_movement) {
								item.DB += compareItem.stats.DBmental_if_movement;
							};
							if (compareItem.stats.SP_to_mental) {
								item.DB += compareItem.stats.SP_to_mental * (stats.SP.total + item.SP);
							};
							if (equipped.SP_to_mental) {
								item.DB += equipped.SP_to_mental * item.SP;
							};
							break;
					};
					for (tag in stats.DR.subtype) {
						if (!(stats.DR.subtype[tag].damagetype)) {
							item.DB += ((compareItem.stats["DR" + tag]) ? tagThing[tag] * compareItem.stats["DR" + tag] / 4000 : 0) + ((compareItem.stats["DB" + tag]) ? tagThing[tag] * compareItem.stats["DB" + tag] : 0);
							if (tag == "area" && tagThing.energy > 0 && compareItem.stats.DBarea_if_energy) {
								item.DB += tagThing[tag] * compareItem.stats.DBarea_if_energy;
							};
							if (tag == "movement") {
								item.DB += tagThing[tag] * item.SPE * 0.02;
							};
						};
					};
					if (tagThing.physical * tagThing.energy > 0 || tagThing.physical * tagThing.mental > 0 || tagThing.energy * tagThing.mental > 0) {
						item.DB += (compareItem.stats.DRcosmic) ? compareItem.stats.DRcosmic / 4000 : 0;
					};
					if (tagThing.ranged > 0 && compareItem.stats["DR" + k + "_if_ranged"]) {
						item.DB += compareItem.stats["DR" + k + "_if_ranged"] / 4000;
					};
					item.DB += ezDB[k];
					itemIndex += tagThing[k] * calcIndex(item.DB, item.CR, item.CD, item.BR, item.BD);
				};
			};
			thisOption.dmg = ((output == "ome" || output == "syn") && thisOption.equipped) ? (ezIndex - itemIndex) / itemIndex : (itemIndex - ezIndex) / ezIndex;
			if (output == "ome") {
				thisOption.efficiency = (compareItem.cost > 0 || thisOption.equipped) ? 4000 * thisOption.dmg / ((thisOption.equipped) ? thisOption.cost() : compareItem.cost) : 0;
				thisOption.newcost = (compareItem.cost == 0 && thisOption.equipped) ? -thisOption.cost() : compareItem.cost;
			};
		};
		var displayArray = [];
		for (option in systemObject) {
			displayArray.push(systemObject[option]);
			displayArray[displayArray.length - 1].key = option;
		};
		if (output == "ome") {
			displayArray.sort(function (a, b) {
				if (a.efficiency == b.efficiency) {
					return b.dmg - a.dmg;
				} else {
					return b.efficiency - a.efficiency;
				};
			});
		} else {
			displayArray.sort(function (a, b) {
				if (a.dmg == b.dmg) {
					if ((a.equipped && b.equipped) || (!(a.equipped) && !(b.equipped))) {
						if (a.name == b.name) {
							return b.grade - a.grade;
						} else {
							return b.name - a.name;
						};
					} else {
						if (a.equipped) {
							return -1;
						} else {
							return 1;
						};
					};
				} else {
					return b.dmg - a.dmg;
				};
			});
		};
		if (output == "ome") {
			var omegaTotal = 0;
		};
		for (var i = 0; i < displayArray.length; i++) {
			var optionName = document.getElementById(output + "Name" + i);
			var optionStats = document.getElementById(output + "Stats" + i);
			var optionRow = optionName.parentNode;
			optionRow.id = output + displayArray[i].key;
			if (output != "att") {
				optionRow.onclick = function () {
					var selection = this.id.slice(3);
					selectOption(system, selection);
				};
			};
			optionName.innerHTML = displayArray[i].name + ((displayArray[i].grade) ? " (Grade " + displayArray[i].grade + ")" : "") + ((displayArray[i].rank) ? " (Rank " + displayArray[i].rank + ")" : "");
			optionName.style.backgroundColor = "initial";
			optionName.style.color = "initial";
			optionStats.innerHTML = "";
			for (stat in displayArray[i].stats) {
				optionStats.innerHTML += "&nbsp;" + stat + ": " + displayArray[i].stats[stat] + "<br>";
			};
			if (displayArray[i].equipped) {
				optionName.style.backgroundColor = "2080F0";
				optionName.style.color = "FFFFFF";
			};
			if ((output == "ome" || output == "syn") && displayArray[i].equipped) {
				var dmgDisplay = "(" + ((displayArray[i].dmg > 0) ? "+ " : "") + fixedToPercent(displayArray[i].dmg) + ")&nbsp;"
			} else {
				var dmgDisplay = ((displayArray[i].dmg > 0) ? "+ " : "") + fixedToPercent(displayArray[i].dmg) + "&nbsp;"
			};
			document.getElementById(output + "DPS" + i).innerHTML = dmgDisplay;
			if (output == "ome") {
				if (displayArray[i].equipped) {
					omegaTotal -= displayArray[i].newcost;
				};
				var divisionName = function (key) {
					var abbr = key.slice(0, 2);
					var divisions = {
							AA: "Arcane Attunement",
							HA: "Human Augmentation",
							MA: "Molecular Adjustment",
							MU: "Mutation",
							NE: "Neural Enhancement",
							NT: "Nanotechnology",
							PS: "Psionics",
							RO: "Radioactive Origins",
							SW: "Special Weapons Support",
					};
					return divisions[abbr];
				};
				document.getElementById(output + "Division" + i).innerHTML = divisionName(displayArray[i].key);
				document.getElementById(output + "Efficiency" + i).innerHTML = fixedToPercent(displayArray[i].efficiency) + "&nbsp;";
				document.getElementById(output + "Cost" + i).innerHTML = ((displayArray[i].equipped) ? "(" + -displayArray[i].newcost + ")" : displayArray[i].newcost) + "&nbsp;";
			};
		};
		if (output == "ome") {
			document.getElementById("omegaTotal").innerHTML = ((omegaTotal > 7500) ? "<a style = 'color: red'>" : "") + omegaTotal + ((omegaTotal > 7500) ? "</a>" : "") + "/7500 &Omega;";
		};
	};
	for (system in masterOptions) {
		optionDPS(system);
	};
// Stat weighting
	var compositeDR = tagThing.physical * ezDB.physical + tagThing.energy * ezDB.energy + tagThing.mental * ezDB.mental;
	var compositeCR = tagThing.physical * ezCR.physical + tagThing.energy * ezCR.energy + tagThing.mental * ezCR.mental;
	var up = {CR: {value: (ezIndex * 1.01 / compositeDR - 1) / (stats.CD.actual + stats.BR.actual * (stats.BD.actual - stats.CD.actual) - 1),
			subtype: {}},
		CD: {value: (ezIndex * 1.01 / compositeDR + compositeCR - (stats.BD.actual - stats.CD.actual) * compositeCR * stats.BR.actual - 1) / compositeCR - stats.CD.actual},
		BR: {value: (ezIndex * 1.01 / compositeDR + compositeCR - stats.CD.actual * compositeCR - 1) / (compositeCR * (stats.BD.actual - stats.CD.actual))},
		BD: {value: (ezIndex * 1.01 / compositeDR - 1 + compositeCR * (1 - stats.CD.actual + stats.CD.actual * stats.BR.actual)) / (compositeCR * stats.BR.actual) - stats.BD.actual},
		DR: {value: 0.01 * compositeDR,
			subtype: {}},
		DB: {value: 0.01 * compositeDR,
			subtype: {}},
		HP: {value: 0.01 * compositeDR / tagThing.HP},
		SP: {value: 0.01 * compositeDR / tagThing.SP},
		DF: {value: 0.01 * compositeDR / tagThing.DF}
	};
	var bonusCR = stats.CR.actual - stats.CR.total * 0.99 / (stats.CR.total + 3601);
	up.CR.value = (up.CR.value > 0 && up.CR.value - bonusCR < 0.99) ? up.CR.value - compositeCR : 0;
	var bonusBR = stats.BR.actual - stats.BR.total * 0.75 / (stats.BR.total + 3601);
	up.BR.value = (up.BR.value > 0 && up.BR.value - bonusBR < 0.75) ? brutToRating(up.BR.value - bonusBR) - stats.BR.total : 0;
	for (k in stats.CR.subtype) {
		up.CR.subtype[k] = {value: up.CR.value / tagThing[k]};
		up.CR.subtype[k].value = critToRating(up.CR.subtype[k].value + compositeCR - bonusCR) - critToRating(compositeCR - bonusCR);
	};
	up.CR.value = critToRating(up.CR.value + compositeCR - bonusCR) - critToRating(compositeCR - bonusCR);
	for (k in stats.DR.subtype) {
		up.DR.subtype[k] = {value: up.DR.value / tagThing[k]};
		up.DB.subtype[k] = {value: up.DR.value / tagThing[k]};
	};
// print tag percentages
	for (k in tagThing) {
		document.getElementById("tag_EZ" + k).innerHTML = "" + fixedToPercent(tagThing[k]);
	};
// print sheet / totals / actuals
	var printStats = function (prefix, subtype) {
		var fieldName = prefix + ((subtype) ? subtype : "");
		var currentStat = (subtype) ? stats[prefix].subtype[subtype] : stats[prefix];
		var linkedValue = ((currentStat.linked) ? stats[prefix].value : 0) + calcLinks(prefix, subtype);
		if (!(currentStat.nosheet)) {
			document.getElementById("sheet_" + fieldName).innerHTML = (currentStat.percent) ? fixedToPercent(currentStat.value + linkedValue) : currentStat.value + linkedValue;
		};
		document.getElementById("total_" + fieldName).innerHTML = (currentStat.percent) ? fixedToPercent(currentStat.total) : currentStat.total;
		document.getElementById("actual_" + fieldName).innerHTML = ((prefix == "CD" || prefix == "BD") ? "x " : "") + ((prefix == "DR" || prefix == "DB") ? "+ " : "") + ((currentStat.integertotal) ? currentStat.actual : fixedToPercent(currentStat.actual));
	};
	for (x in stats) {
		printStats(x);
		if (stats[x].subtype) {
			for (y in stats[x].subtype) {
				printStats(x, y);
			};
		};
	};
	document.getElementById("tag_EZtotal").innerHTML = fixedToPercent(ezIndex);
	var printWeights = function (prefix, subtype) {
		var fieldName = prefix + ((subtype) ? subtype : "");
		var fieldValue = (subtype) ? up[prefix].subtype[subtype].value : up[prefix].value;
		var value = 0;
		var weight = 0;
		switch(prefix) {
			case "CR":
			case "BR":
				value = Math.round(fieldValue);
				weight = fixedToPercent(up.DR.value * 4000 / fieldValue);
				break;
			case "CD":
			case "BD":
				value = Math.round(fieldValue * 8000);
				weight = fixedToPercent(up.DR.value * 4000 / (fieldValue * 8000));
				break;
			case "DR":
			case "HP":
			case "SP":
			case "DF":
				value = Math.round(fieldValue * 4000);
				weight = fixedToPercent(up.DR.value / fieldValue);
				break;
			case "DB":
				value = fixedToPercent(fieldValue);
				weight = Math.round(up.DR.value / fieldValue * 40);
				break;
		};
		if (value <= 0 || value == Infinity || weight <= 0 || weight == Infinity) {
			value = "";
			weight = "";
		};
		document.getElementById("value_" + fieldName).innerHTML = value;
		document.getElementById("weight_" + fieldName).innerHTML = weight;
	};
	for (x in up) {
		printWeights(x);
		if (up[x].subtype) {
			for (y in up[x].subtype) {
				printWeights(x, y);
			};
		};
	};
	saveState();
};

function calcIndex (damageMult, critChance, critMult, brutChance, brutMult) {
	damageMult = Math.max(0, damageMult);
	critChance = Math.max(0, critChance);
	critMult = Math.max(0, critMult);
	brutChance = Math.max(0, brutChance);
	brutMult = Math.max(0, brutMult);
	var damageIndex = damageMult * ((1 - critChance) + (critMult * (critChance - (critChance * brutChance))) + (brutMult * (critChance * brutChance)));
	return damageIndex;
};

function critToRating (chance) {
	if (chance > 0.99) {
		chance = 0.99;
	};
	return chance * 3601 / (0.99 - chance);
};

function brutToRating (chance) {
	if (chance > 0.75) {
		chance = 0.75;
	};
	return chance * 3601 / (0.75 - chance);
};

function percentToFixed (percentString) {
	return Number(percentString.slice(0, percentString.length - 1)) / 100;
};

function fixedToPercent (fixed) {
	return (Math.round(fixed * 10000) / 100).toFixed(2) + "%";
};

function kbinput (keypress) {
	var keyCode = keypress.which
	if (keyCode == 8 || keyCode == 9 || keyCode == 38 || keyCode == 40) {
		keypress.preventDefault();
	};
	if (keyCode == 9) {
		keyCode = (keypress.shiftKey) ? 37 : 40;
	};
	readText (selectedField);
	switch (keyCode) {
		case 46:
			textbuffer = "";
			document.getElementById(selectedField).innerHTML = textbuffer + textsuffix;
			editing = 1;
			break;
		case 8:
			if (textbuffer.length > 0) {
				textbuffer = textbuffer.slice(0, textbuffer.length-1);
				document.getElementById(selectedField).innerHTML = textbuffer + textsuffix;
			};
			editing = 1;
			break;
		case 13:
		case 37:
		case 38:
		case 39:
		case 40:
			var fieldArray = document.getElementsByClassName("input");
			var fieldIndex = 0;
			while (fieldArray[fieldIndex].id != selectedField) {
				fieldIndex++;
			};
			switch (keyCode) {
				case 37:
				case 38:
					fieldIndex = (fieldIndex == 0) ? fieldArray.length - 1 : fieldIndex - 1;
					while (fieldArray[fieldIndex].parentNode.hidden) {
						fieldIndex = (fieldIndex == 0) ? fieldArray.length - 1 : fieldIndex - 1;
					};
					break;
				case 13:
				case 39:
				case 40:
					fieldIndex = (fieldIndex == fieldArray.length - 1) ? 0 : fieldIndex + 1;
					while (fieldArray[fieldIndex].parentNode.hidden) {
						fieldIndex = (fieldIndex == fieldArray.length - 1) ? 0 : fieldIndex + 1;
					};
					break;
			};
			selectField(fieldArray[fieldIndex].id);
			break;
		default:
			if (keyCode > 95 && keyCode < 106) {
				keyCode -= 48;
			};
			if (keyCode == 110 || keyCode == 190) {
				keyCode = 46;
			};
			if (keyCode == 109 || keyCode == 173) {
				keyCode = 45;
			};
			if ((keyCode > 47 && keyCode < 58) || keyCode == 45 || keyCode == 46) {
				if (editing == 0) {
					textbuffer = String.fromCharCode(keyCode);
					editing = 1;
				} else {
					if (keyCode == 45) {
						if (textbuffer.substr(0,1) == "-") {
							textbuffer = textbuffer.substr(1);
						} else {
							if (textbuffer == "0") {
								textbuffer = "";
							};
							textbuffer = "-" + textbuffer;
						};
					} else if (keyCode != 46 || textbuffer.indexOf(".") == -1) {
						var maxDigits = 10;
						if (textbuffer.length < maxDigits) {
							textbuffer += String.fromCharCode(keyCode);
						};
					};
				};
				document.getElementById(selectedField).innerHTML = textbuffer + textsuffix;
			};
			break;
	};
};

function resetChecks() {
	var checkArray = document.getElementsByClassName("checkbox");
	for (var i = 0; i < checkArray.length; i++) {
		checkArray[i].checked = false;
	};
	tagCheck();
};

function tagCheck() {
	var checkArray = document.getElementsByClassName("checkbox");
	for (var i = 0; i < checkArray.length; i++) {
		var tag = checkArray[i].id.substr(5);
		tag = (tag.length > 2) ? tag.toLowerCase() : tag;
		toggleBlock(tag, checkArray[i].checked);
	};
};

function toggleBlock(block, state) {
	var blockArray = document.getElementsByClassName(block);
	for (var i = 0; i < blockArray.length; i++) {
		blockArray[i].hidden = (state == true) ? false : true;
	};
};

function saveState () {
	var rawString = "bas";
	for (k in stats) {
		if (!(stats[k].integertotal)) {
			var integerString = (stats[k].percent) ? Math.round(stats[k].value * 10000) : stats[k].value;
			rawString += integerTo64(integerString) + ((k == "DB") ? "" : ",");
		};
	};
	for (k in tagThing) {
		if (tagThing[k] != "0") {
			rawString += ":";
			var tagPercent = Math.round(tagThing[k] * 10000);
			if (k != "HP" && k != "SP" && k != "DF" && k != "TN") {
				var tagCR = (stats.CR.subtype[k]) ? stats.CR.subtype[k].value : "-";
				var tagDR = (stats.DR.subtype[k]) ? stats.DR.subtype[k].value : "-";
				var tagDB = (stats.DB.subtype[k]) ? Math.round(stats.DB.subtype[k].value * 10000) : "-";
				rawString += k.slice(0, 3) + integerTo64(tagPercent) + "," + integerTo64(tagCR) + "," + integerTo64(tagDR) + "," + integerTo64(tagDB);
			} else {
				var tagValue = (stats[k]) ? stats[k].value : "-";
				rawString += k + "_" + integerTo64(tagPercent) + "," + integerTo64(tagValue);
			};
		};
	};
	var equipcode = {};
	for (system in masterOptions) {
		var systemObject = masterOptions[system];
		var stem = system.substr(0, 3).toLowerCase();
		switch (stem) {
			case "ble":
			case "leg":
			case "med":
			case "rel":
				equipcode[stem] = 0;
				var optionIndex = 0;
				for (option in systemObject) {
					if (systemObject[option].equipped) {
						equipcode[stem] = optionIndex + 1;
					};
					optionIndex++;
				};
				break;
			case "cos":
			case "syn":
				equipcode[stem] = [];
				var optionIndex = 0;
				for (option in systemObject) {
					if (systemObject[option].equipped) {
						equipcode[stem].push(optionIndex  + 1);
					};
					optionIndex++;
				};
				break;
			case "ome":
				break;
		};
	};
	if (equipcode.leg + equipcode.med + equipcode.rel + equipcode.ble > 0) {
		rawString += ":equ" + integerTo64(equipcode.leg) + "," + integerTo64(equipcode.med) + ","  + integerTo64(equipcode.rel) + "," + integerTo64(equipcode.ble);
	};
	if (equipcode.syn.length > 0) {
		rawString += ":syn";
		for (var i = 0; i < equipcode.syn.length; i++) {
			rawString += integerTo64(equipcode.syn[i]) + ((i < equipcode.syn.length - 1) ? "," : "");
		};
	};
	if (equipcode.cos.length > 0) {
		rawString += ":cos";
		for (var i = 0; i < equipcode.cos.length; i++) {
			rawString += integerTo64(equipcode.cos[i]) + ((i < equipcode.cos.length - 1) ? "," : "");
		};
	};
	var cleanURL = location.href.substr(0,location.href.indexOf("?"));
	document.getElementById("permalink").href = cleanURL + "?" + rawString;
};

function integerTo64 (number) {
	var digit = "";
	var result = "";
	while (number >= 64) {
		digit = number % 64;
		result+= base64.charAt(digit);
		number = Math.floor(number / 64);
	};
	result += base64.charAt(number);
	return result;
};

function integerFrom64 (string) {
	result = 0;
	digits = 0;
	while (string.length > 0) {
		result += base64.indexOf(string.substr(0, 1)) * Math.pow(64, digits);
		digits++;
		string = string.substr(1, string.length);
	};
	return result;
	return base64.indexOf("G");
};
-->
</script>
</head>
<body onload="initialize();" onKeyDown="kbinput(event);">
<a id="permalink" href="" style="font-family:arial;">configuration permalink</a>
<br>
<br>
<table onclick="tagCheck();">
<tr><td class="heading center" colspan=3>Power Tags</td>
<td class="heading center" colspan=3>Stat Conversion</td>
</tr>
<tr>
<td><label><input class="checkbox" type=checkbox id="checkPhysical">Physical</label></td>
<td><label><input class="checkbox" type=checkbox id="checkMelee">Melee</label></td>
<td><label><input class="checkbox" type=checkbox id="checkDot">DOT</label></td>
<td><label><input class="checkbox" type=checkbox id="checkHP">Health</label></td>
</tr>
<tr>
<td><label><input class="checkbox" type=checkbox id="checkEnergy">Energy</label></td>
<td><label><input class="checkbox" type=checkbox id="checkRanged">Ranged</label></td>
<td><label><input class="checkbox" type=checkbox id="checkBoss">Boss</label></td>
<td><label><input class="checkbox" type=checkbox id="checkSP">Spirit</label></td>
</tr>
<tr>
<td><label><input class="checkbox" type=checkbox id="checkMental">Mental</label></td>
<td><label><input class="checkbox" type=checkbox id="checkArea">Area</label></td>
<td><label><input class="checkbox" type=checkbox id="checkUnaware">Unaware</label></td>
<td><label><input class="checkbox" type=checkbox id="checkDF">Defense</label></td>
</tr>
<tr>
<td></td>
<td><label><input class="checkbox" type=checkbox id="checkMovement">Movement</label></td>
<td></td>
<td><label><input class="checkbox" type=checkbox id="checkTN">Tenacity</label></td>
</tr>
</table>
<table id="tagTable">
<tr>
<td class="heading">Damage Types</td>
</tr>
<tr class="physical">
<td>&nbsp; Physical</td>
<td class="field input tag" id="tag_EZphysical" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="energy">
<td>&nbsp; Energy</td>
<td class="field input tag" id="tag_EZenergy" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="mental">
<td>&nbsp; Mental</td>
<td class="field input tag" id="tag_EZmental" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr>
<td class="heading">Power Tags</td>
</tr>
<tr class="melee">
<td>&nbsp; Melee</td>
<td class="field input tag" id="tag_EZmelee" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="ranged">
<td>&nbsp; Ranged</td>
<td class="field input tag" id="tag_EZranged" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="area">
<td>&nbsp; Area</td>
<td class="field input tag" id="tag_EZarea" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="dot">
<td>&nbsp; DOT</td>
<td class="field input tag" id="tag_EZdot" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="movement">
<td>&nbsp; Movement</td>
<td class="field input tag" id="tag_EZmovement" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr>
<td class="heading">Status</td>
</tr>
<tr class="boss">
<td>&nbsp; Boss</td>
<td class="field input tag" id="tag_EZboss" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="unaware">
<td>&nbsp; Unaware</td>
<td class="field input tag" id="tag_EZunaware" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr>
<td class="heading">Stat Conversion</td>
</tr>
<tr class="HP">
<td>&nbsp; Health &rarr; DR</td>
<td class="field input tag" id="tag_EZHP" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="SP">
<td>&nbsp; Spirit &rarr; DR</td>
<td class="field input tag" id="tag_EZSP" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="DF">
<td>&nbsp; Defense &rarr; DR</td>
<td class="field input tag" id="tag_EZDF" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr class="TN">
<td>&nbsp; Tenacity &rarr; CR</td>
<td class="field input tag" id="tag_EZTN" onclick="selectField(this.id);">0.00%</td>
</tr>
<tr>
<td class="heading">Damage Index:</td>
<td class="field output" id="tag_EZtotal">0.00%</td>
</tr>
</table>

<table id="rotationTable" hidden>
<tr>
<td class="heading">Advanced</td>
<td><button type="button" disabled>Basic</button></td>
</tr>
</table>

<br>
<table id="statsTable">
</table>
<br>
<table id="optionHeadings">
<tr></tr>
</table>
<a id="comparisons"></a>
<br>
<a id=debug></a>
</body></html>
